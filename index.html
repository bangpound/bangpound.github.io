<!DOCTYPE html>
<html>
<head>
    <title>Home &mdash; !&amp;# &mdash; bangpound</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, follow">

<link rel="openid.server" href="https://bangpound.wordpress.com/?openidserver=1" />
<link rel="openid.delegate" href="https://bangpound.wordpress.com/" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="!&amp;# activity feed" />
    <link rel="stylesheet" href="/css/main.css">
</head>
<body class="page__wrapper">
<div class="page">
    <header class="page__header">
        <h1 class="site-name"><a href="/">!&amp;#</a></h1>
        <nav class="main-menu">
            <ul class="main-menu__list">
                <li><a href="/about" class="main-menu__link">About</a></li>
                <li><a href="/blog" class="main-menu__link">Blog</a></li>
            </ul>
        </nav>
    </header>
    <main class="page__main">
    <article>
        <header>
            <h2><a href="/blog/2015/06/26/genet">Genet</a></h2>
        </header>
        <p><iframe src="https://player.vimeo.com/video/4769870" width="480" height="368" frameborder="0" title="Jean Genet" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></p>

            </article>
    <article>
        <header>
            <h2><a href="/blog/2015/06/25/guzzle-6-logging-with-symfony-whats-the-right-way-to-create-a-callback-service">Guzzle 6 Logging with Symfony: what&#039;s the right way to create a callback service?</a></h2>
        </header>
        <p>The <a href="https://github.com/guzzle/guzzle/releases/tag/6.0.0">latest version of Guzzle</a> uses PSR-7. Functionality that
previously was based on events is now implemented as middleware. The <a href="https://github.com/guzzle/log-subscriber">log subscriber</a>
is not supported, and the logging middleware is part of the main Guzzle package.</p>

<p>This is how I implemented a Guzzle service with logging with Symfony's container.</p>

<pre><code class="language-yaml">parameters:
    guzzle.class: GuzzleHttp\Client
    guzzle.stack.class: GuzzleHttp\HandlerStack
    guzzle.middleware.class: GuzzleHttp\Middleware
    guzzle.message_formatter.class: GuzzleHttp\MessageFormatter

services:
    guzzle:
        class: %guzzle.class%
        arguments:
            -
                handler: @guzzle.stack

    guzzle.stack:
        public: false
        class: %guzzle.stack.class%
        factory: [ %guzzle.stack.class%, create ]
        calls:
            - [ push, [ @guzzle.logger ] ]

    guzzle.message_formatter:
        public: false
        class: %guzzle.message_formatter.class%

    guzzle.logger:
        public: false
        class: callback
        arguments: [@logger, @guzzle.message_formatter]
        factory: [GuzzleHttp\Middleware, log]
</code></pre>

<p>On the <code>guzzle.logger</code> service, the <code>callback</code> class is actually invalid, but without a class, it complains:</p>

<blockquote>
<p>[Symfony\Component\DependencyInjection\Exception\RuntimeException] Please add the class to service &quot;guzzle.logger&quot; even if it is constructed by a factory since we might need to add method calls based on compile-time checks.</p>
</blockquote>

<p>Nonetheless, when the dependencies are not public, Symfony compiles the Guzzle client service with a logger correctly.</p>

<pre><code class="language-php">&lt;?php

use Symfony\Component\DependencyInjection\Container;

class appDevDebugProjectContainer extends Container
{
    protected function getGuzzleService()
    {
        $a = \GuzzleHttp\HandlerStack::create();
        $a-&gt;push(\GuzzleHttp\Middleware::log(
            $this-&gt;get('logger'),
            new \GuzzleHttp\MessageFormatter()
        ));

        return $this-&gt;services['guzzle'] = new \GuzzleHttp\Client(array(
            'handler' =&gt; $a
        ));
    }
}
</code></pre>

<p>Given that Symfony services must be objects with classes, what is the right way to create a service with callbacks
without using a factory? The trick is to create the service without a factory, because if the service is
constructed entirely within the container, it could be configured or extended with container extensions and compiler
passes.</p>

                    <p class="tags">
            Tags:
                        <a href="/blog/tags/PHP">PHP</a>,                         <a href="/blog/tags/Guzzle">Guzzle</a>,                         <a href="/blog/tags/Symfony">Symfony</a>                        </p>
            </article>
    <article>
        <header>
            <h2><a href="/blog/2015/06/22/cube">Cube</a></h2>
        </header>
        <p><img src="/images/tumblr_nq5yddDasX1r2geqjo1_540.gif" alt="cube" /></p>

            </article>
    </main>
    <footer class="page__footer">
        <p>&copy; 2016 Benjamin J Doherty</p>
    </footer>
</div>


<script src="/js/prism.js"></script>
</body>
</html>
